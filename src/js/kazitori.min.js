/*! kazitori.js - v0.2.3 - 2013-06-03
* https://github.com/glassesfactory/kazitori.js
* Copyright (c) 2013 Eikichi Yamaguchi; Licensed MIT */
var Deffered,EventDispatcher,InternalGroup,Kazitori,KazitoriEvent,Rule,VARIABLE_TYPES,delegater,escapeRegExp,genericParam,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__indexOf=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1},__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};delegater=function(t,e){return function(){return e.apply(t,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/<(\w+|[A-Za-z_-]+:\w+)>/g,genericParam=/([A-Za-z_-]+):(\w+)/,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,VARIABLE_TYPES=[{name:"int",cast:Number},{name:"string",cast:String}],Kazitori=function(){function t(t){this.observeURLHandler=__bind(this.observeURLHandler,this),this.beforeFailed=__bind(this.beforeFailed,this),this.executeHandlers=__bind(this.executeHandlers,this),this._executeBefores=__bind(this._executeBefores,this),this.beforeComplete=__bind(this.beforeComplete,this);var e,r;this._processStep.status="constructor",this._processStep.args=[t],this.options=t||(t={}),t.routes&&(this.routes=t.routes),this.root=t.root?t.root:null===this.root?"/":this.root,this.isTemae=t.isTemae?t.isTemae:!1,this.silent=t.silent?t.silent:!1,this._params={params:[],queries:{},fragment:null},null===this.notFound&&(this.notFound=t.notFound?t.notFound:this.root),r=window,r!==void 0&&(this.location=r.location,this.history=r.history),e=document.docmentMode,this.isIE=-1!==r.navigator.userAgent.toLowerCase().indexOf("msie"),this.isOldIE=this.isIE&&(!e||7>e),this._dispatcher=new EventDispatcher,this.handlers=[],this.beforeHandlers=[],this._bindBefores(),this._bindRules(),this._bindNotFound();try{Object.defineProperty(this,"params",{enumerable:!0,get:function(){return this._params.params}}),Object.defineProperty(this,"queries",{enumerable:!0,get:function(){return this._params.queries}})}catch(i){}(null==this.options.isAutoStart||this.options.isAutoStart!==!1)&&this.start()}return t.prototype.VERSION="0.9.9",t.prototype.history=null,t.prototype.location=null,t.prototype.handlers=[],t.prototype.beforeHandlers=[],t.prototype.afterhandlers=[],t.prototype.rootFiles=["index.html","index.htm","index.php","unko.html"],t.prototype.root=null,t.prototype.notFound=null,t.prototype.beforeAnytimeHandler=null,t.prototype.direct=null,t.prototype.isIE=!1,t.prototype.silent=!1,t.prototype.started=!1,t.prototype._params={params:[],fragment:""},t.prototype.beforeFailedHandler=function(){},t.prototype.isBeforeForce=!1,t.prototype.isTemae=!1,t.prototype._changeOptions=null,t.prototype.isNotFoundForce=!1,t.prototype._notFoudn=null,t.prototype.breaker={},t.prototype._dispatcher=null,t.prototype._beforeDeffer=null,t.prototype.fragment=null,t.prototype.lastFragment=null,t.prototype.isUserAction=!1,t.prototype._isFirstRequest=!0,t.prototype.isSuspend=!1,t.prototype._processStep={status:"null",args:[]},t.prototype.start=function(t){var e,r,i,s,n,o;if(this._processStep.status="start",this._processStep.args=[t],this.started)throw Error("mou hazim matteru");return this.started=!0,o=window,this.options=this._extend({},{root:"/"},this.options,t),this._hasPushState=!(!this.history||!this.history.pushState),this._wantChangeHash=this.options.hashChange!==!1,r=this.fragment=this.getFragment(),e=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isIE&&!e&&(s=this.location.pathname.replace(this.root,""),this._updateHashIE(s)),this.isOldIE&&this._wantChangeHash&&(i=document.createElement("iframe"),i.setAttribute("src","javascript:0"),i.setAttribute("tabindex","-1"),i.style.display="none",document.body.appendChild(i),this.iframe=i.contentWindow,this.change(r)),this._addPopStateHandler(),this._hasPushState&&e&&this.location.hash&&(this.fragment=this.lastFragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.START,this.fragment)),n=this.root,this.silent||(!this._hasPushState&&e?n=this.root+this.fragment.replace(routeStripper,""):e||(n=this.fragment)),this.loadURL(n)},t.prototype.stop=function(){var t;return t=window,t.removeEventListener("popstate",this.observeURLHandler),t.removeEventListener("hashchange",this.observeURLHandler),this.started=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.STOP,this.fragment))},t.prototype.torikazi=function(t){return this.direction(t,"next")},t.prototype.omokazi=function(t){return this.direction(t,"prev")},t.prototype.direction=function(t,e){var r;if(!this.started)return!1;if(r=this.lastFragment,this.lastFragment=this.getFragment(),this.direct=e,this.isUserAction=!0,this._removePopStateHandler(),"prev"===e)this.history.back(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,r,this.lastFragment));else{if("next"!==e)return;this.history.forward(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,r,this.lastFragment))}return this._addPopStateHandler(),this.loadURL(r)},t.prototype.change=function(t,e){var r,i,s,n;return this.started?(this._processStep.status="change",this._processStep.args=[t,e],e||(e={trigger:e}),this._changeOptions=e,this.isBeforeForce=e.isBeforeForce!==!1,r=this.getFragment(t||""),this.fragment!==r?(this.lastFragment=this.fragment,this.fragment=r,s=this.fragment,n=this.root+this._replace.apply(r,[routeStripper,""]),i=this._matchCheck(this.fragment,this.handlers),i===!1&&this.isNotFoundForce===!1?(null!==this.notFound&&(this._notFound.callback(this.fragment),n=this.root+this._notFound.rule.replace(routeStripper,""),this.history[e.replace?"replaceState":"pushState"]({},document.title,n)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND)),void 0):(this.isTemae&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(r):this._urlChange(r,e),void 0)):void 0):!1},t.prototype.replace=function(t,e){this._processStep.status="replace",this._processStep.args=[t,e],e?e.replace&&e.replace!==!1||(e.replace=!0):e={replace:!0},this.change(t,e)},t.prototype._urlChange=function(t,e){var r;if(this._processStep.status="_urlChange",this._processStep.args=[t,e],!this.isSuspend){if(e||(e=this._changeOptions),r=this.root+this.fragment.replace(routeStripper,""),!this.silent)if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantChangeHash)return this.location.assign(r);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return this.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,this.fragment,this.lastFragment)),e.internal&&e.internal===!0&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.INTERNAL_CHANGE,this.fragment,this.lastFragment)),this.loadURL(this.fragment,e)}},t.prototype.reject=function(){this.dispatchEvent(new KazitoriEvent(KazitoriEvent.REJECT,this.fragment)),this._beforeDeffer&&(this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer=null)},t.prototype.suspend=function(){null!=this._beforeDeffer&&this._beforeDeffer.suspend(),this.started=!1,this.isSuspend=!0,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.SUSPEND,this.fragment,this.lastFragment))},t.prototype.resume=function(){null!=this._beforeDeffer&&this._beforeDeffer.resume(),this.started=!0,this.isSuspend=!1,this[this._processStep.status](this._processStep.args),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.RESUME,this.fragment,this.lastFragment))},t.prototype.registerHandler=function(e,r,i,s){var n,o;if(!s)if(i)s=this._bindFunctions(r);else{if(r instanceof t)return this._bindChild(e,r),this;if("function"==typeof r)if(r.hasOwnProperty("__super__"))try{return n=new r({isAutoStart:!1}),this._bindChild(e,n),this}catch(a){s=r}else s=r;else s=this[r]}return o=i?this.beforeHandlers:this.handlers,o.unshift(new Rule(e,function(t){var e;return e=this.router.extractParams(this,t),s&&s.apply(this.router,e)},this)),this},t.prototype._bindChild=function(t,e){var r,i,s,n,o,a,h,p;for(e.reject(),e.stop(),s=e.handlers.concat(),o=0,h=s.length;h>o;o++)n=s[o],n.update(t);for(this.handlers=s.concat(this.handlers),i=e.beforeHandlers.concat(),a=0,p=i.length;p>a;a++)r=i[a],r.update(t);return this.beforeHandlers=i.concat(this.beforeHandlers),e.beforeAnytimeHandler?(this.lastAnytime=this.beforeAnytime.concat(),this._bindBeforeAnytime(this.beforeAnytime,[e.beforeAnytimeHandler.callback])):void 0},t.prototype.appendRouter=function(e,r){var i,s;if(!e instanceof t&&"function"!=typeof e)throw Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。");if(e instanceof t)return i=this._getChildRule(e,r),this._bindChild(i,e),this;if(e.hasOwnProperty("__super__"))try{return s=new e({isAutoStart:!1}),i=this._getChildRule(s,r),this._bindChild(i,s),this}catch(n){throw Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。")}return this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.ADDED,this.fragment,this.lastFragment)),this},t.prototype._getChildRule=function(t,e){var r;if(r=t.root,e&&(r=e),r.match(trailingSlash)&&(r=r.replace(trailingSlash,"")),r===this.root)throw Error("かぶってる");return r},t.prototype.removeRouter=function(e,r){var i;if(!e instanceof t&&"function"!=typeof e)throw Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。");if(e instanceof t)this._unbindChild(e,r);else if(e.hasOwnProperty("__super__"))try{return i=new e({isAutoStart:!1}),this._unbindChild(i,r),this}catch(s){throw Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。")}return this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.REMOVED,this.fragment,this.lastFragment)),this},t.prototype._unbindChild=function(t,e){var r,i,s,n,o,a,h;for(a=this._getChildRule(t,e),i=0,s=this.handlers.length,o=[];s>i;)h=this.handlers.shift(),null===h.rule.match(a)&&o.unshift(h),i++;for(this.handlers=o,i=0,s=this.beforeHandlers.length,n=[];s>i;)r=this.beforeHandlers.shift(),null===r.rule.match(a)&&n.unshift(r),i++;return this.beforeHandlers=n},t.prototype.loadURL=function(t,e){var r;this._processStep.status="loadURL",this._processStep.args=[t,e],this.isSuspend||(r=this.fragment=this.getFragment(t),this.isTemae===!1&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(r):this.executeHandlers())},t.prototype.match=function(t){var e;return e=this._matchCheck(t,this.handlers,!0),e.length>0},t.prototype.beforeComplete=function(){this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.BEFORE_EXECUTED,this.fragment,this.lastFragment)),this.isTemae?this._urlChange(this.fragment,this._changeOptions):this.executeHandlers()},t.prototype._executeBefores=function(t){var e,r,i,s,n=this;for(this._processStep.status="_executeBefores",this._processStep.args=[t],this._beforeDeffer=new Deffered,null!=this.beforeAnytimeHandler&&this._beforeDeffer.deffered(function(e){n.beforeAnytimeHandler.callback(t),e.execute(e)}),r=this._matchCheck(t,this.beforeHandlers),i=0,s=r.length;s>i;i++)e=r[i],this._beforeDeffer.deffered(function(r){e.callback(t),r.execute(r)});return this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.execute(this._beforeDeffer)},t.prototype.executeHandlers=function(){var t,e,r,i,s,n,o,a,h=this;if(this._processStep.status="executeHandlers",this._processStep.args=[],!this.isSuspend){if(i=this._matchCheck(this.fragment,this.handlers),e=!0,i===!1||1>i.length)null!==this.notFound&&this._notFound.callback(this.fragment),e=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));else if(i.length>1)for(s=0,o=i.length;o>s;s++)r=i[s],this.fragment.indexOf(r.rule)>-1&&r.callback(this.fragment);else for(n=0,a=i.length;a>n;n++)t=i[n],t.callback(this.fragment);return this._isFirstRequest?(setTimeout(function(){return h._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.FIRST_REQUEST,h.fragment,null)),e?h._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,h.fragment,null)):void 0},0),this._isFirstRequest=!1):e&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,this.fragment,this.lastFragment)),i}},t.prototype.beforeFailed=function(){this.beforeFailedHandler.apply(this,arguments),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},t.prototype.observeURLHandler=function(){var t;return t=this.getFragment(),t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.change(t),this.lastFragment===t&&this.isUserAction===!1?this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,t,this.fragment)):this.lastFragment===this.fragment&&this.isUserAction===!1&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,t,this.lastFragment)),this.isUserAction=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,t,this.lastFragment)),this.loadURL(t))},t.prototype._bindRules=function(){var t,e,r,i;if(null!=this.routes)for(t=this._keys(this.routes),r=0,i=t.length;i>r;r++)e=t[r],this.registerHandler(e,this.routes[e],!1)},t.prototype._bindBefores=function(){var t,e,r,i;if(this.beforeAnytime&&this._bindBeforeAnytime(this.beforeAnytime),null!=this.befores)for(t=this._keys(this.befores),r=0,i=t.length;i>r;r++)e=t[r],this.registerHandler(e,this.befores[e],!0)},t.prototype._bindBeforeAnytime=function(t,e){var r;return r=this._bindFunctions(t,e),this.beforeAnytimeHandler={callback:this._binder(function(t){var e;return e=[t],r&&r.apply(this,e)},this)}},t.prototype._bindNotFound=function(){var t,e,r,i,s,n,o;if(null!=this.notFound){if("string"==typeof this.notFound){for(o=this.handlers,s=0,n=o.length;n>s;s++)if(i=o[s],i.rule==="/"+this.notFound.replace(this.root,""))return this._notFound=i,void 0}else e=this._keys(this.notFound)[0];r=this.notFound[e],t="function"==typeof r?r:this[r],this._notFound=new Rule(e,function(e){var r;return r=this.router.extractParams(this,e),t&&t.apply(this.router,r)},this)}},t.prototype._updateHash=function(t,e,r){var i;r?(i=t.href.replace(/(javascript:|#).*$/,""),t.replace(i+"#"+e)):t.hash="#"+e},t.prototype._updateHashIE=function(t){return location.replace(this.root+"#/"+t)},t.prototype._matchCheck=function(t,e,r){var i,s,n,o,a,h,p,l,u,f,c,d,_,E,m,g;for(null==r&&(r=!1),f=[],d=t,void 0!==d&&"undefined"!==d&&(h=this._match.apply(d,[/(\?[\w\d=|]+)/g])),h&&(t=t.split("?")[0]),_=0,m=e.length;m>_;_++)if(a=e[_],a.rule===t)f.push(a);else if(a.test(t))if(a.isVariable&&a.types.length>0){for(s=this.extractParams(a,t,r),n=[],l=s.length,p=0;l>p;)i=s[p],c=a.types[p],"object"!=typeof i&&(null===c?n.push(!0):n.push(this._typeCheck(i,c))),p++;for(o=!0,E=0,g=n.length;g>E;E++)u=n[E],u||(o=!1);o&&f.push(a)}else f.push(a);return f.length>0?f:!1},t.prototype.getFragment=function(t){var e,r,i,s,n,o,a;if(null==t||void 0===t)if(this._hasPushState||!this._wantChangeHash){for(t=this.location.pathname,i=!1,e=t,e.match(/^\//)&&(e=e.substr(1)),s=this.root,s.match(/^\//)&&(s=s.substr(1)),a=this.rootFiles,n=0,o=a.length;o>n;n++)r=a[n],(r===e||s+r===e)&&(i=!0);i&&(t=this.root),t+=this.location.search,s=this.root.replace(trailingSlash,""),t.indexOf(s)>-1&&(t=t.substr(s.length))}else t=this.getHash();else s=this.root.replace(trailingSlash,""),t.indexOf(this.root)>-1&&t.indexOf(s)>-1&&(t=t.substr(s.length));return t},t.prototype.getHash=function(){var t;return t=(window||this).location.href.match(/#(.*)$/),null!=t?t[1]:""},t.prototype.extractParams=function(t,e,r){var i,s,n,o,a,h,p,l,u,f,c,d,_;if(null==r&&(r=!1),this._params.params.length>0&&this._params.fragment===e)return this._params.params;if(h=t._regexp.exec(e),null===h&&e.indexOf("?")>-1&&(h=[0,"?"+e.split("?")[1]]),this._params.fragment=e,null!=h){if(o=h.slice(1),n=h[h.length-1],n.indexOf("?")>-1){for(a={},l=n.split("?")[1],f=l.split("&"),d=0,_=f.length;_>d;d++)u=f[d],s=u.split("="),i=s[0],c=s[1]?s[1]:"",c.indexOf("|")>-1&&(c=c.split("|")),a[i]=c;o.pop(),o.push(n.split("?")[0]),p={queries:a},o.push(p),r||(this._params.params=this._getCastedParams(t,o.slice(0)),this._params.queries=a)}else r||(this._params.params=this._getCastedParams(t,o));return o}return this._params.params=[],null},t.prototype._getCastedParams=function(t,e){var r,i,s,n,o,a;if(i=0,!e)return e;if(1>t.types.length)return e;for(s=e.length,r=[];s>i;){if(null===t.types[i])r.push(e[i]);else if("object"==typeof e[i])r.push(e[i]);else for(o=0,a=VARIABLE_TYPES.length;a>o;o++)n=VARIABLE_TYPES[o],t.types[i]===n.name&&r.push(n.cast(e[i]));i++}return r},t.prototype.addEventListener=function(t,e){return this._dispatcher.addEventListener(t,e)},t.prototype.removeEventListener=function(t,e){return this._dispatcher.removeEventListener(t,e)},t.prototype.dispatchEvent=function(t){return this._dispatcher.dispatchEvent(t)},t.prototype._addPopStateHandler=function(){var t;return t=window,this._hasPushState===!0&&t.addEventListener("popstate",this.observeURLHandler),this._wantChangeHash===!0&&__indexOf.call(t,"onhashchange")>=0&&!this.isOldIE?t.addEventListener("hashchange",this.observeURLHandler):void 0},t.prototype._removePopStateHandler=function(){var t;return t=window,t.removeEventListener("popstate",this.observeURLHandler),t.removeEventListener("hashchange",this.observeURLHandler)},t.prototype._slice=Array.prototype.slice,t.prototype._replace=String.prototype.replace,t.prototype._match=String.prototype.match,t.prototype._keys=Object.keys||function(t){var e,r;if(t===!Object(t))throw new TypeError("object ja nai");r=[];for(e in t)Object.hasOwnProperty.call(t,e)&&(r[r.length]=e);return r},t.prototype._binder=function(t,e){var r,i;return i=this._slice,r=i.call(arguments,2),function(){return t.apply(e||{},r.concat(i.call(arguments)))}},t.prototype._extend=function(t){return this._each(this._slice.call(arguments,1),function(e){var r,i;if(e){i=[];for(r in e)i.push(t[r]=e[r]);return i}}),t},t.prototype._each=function(t,e,r){var i,s,n,o;if(null!=t){if(i=Array.prototype.forEach,i&&t.forEach===i)return t.forEach(e,r);if(t.length===+t.length)for(s=0,o=t.length;o>s;){if(e.call(r,t[s],s,t)===this.breaker)return;s++}else for(n in t)if(__indexOf.call(t,n)>=0&&e.call(r,t[n],n,t)===this.breaker)return}},t.prototype._bindFunctions=function(t,e){var r,i,s,n,o,a,h,p,l,u,f;for("string"==typeof t&&(t=t.split(",")),r=[],u=0,f=t.length;f>u;u++){if(o=t[u],n=this[o],null==n)if(p=o.split("."),p.length>1){for(s=window[p[0]],a=1,h=p.length;h>a&&(l=s[p[a]],null!=l);)s=l,a++;n=s}else n=window[o];null!=n&&r.push(n)}return e&&(r=e.concat(r)),i=function(t){var e,i;for(e=0,i=r.length;i>e;e++)n=r[e],n.apply(this,[t])}},t.prototype._typeCheck=function(t,e){var r,i,s,n;for(r=!1,s=0,n=VARIABLE_TYPES.length;n>s;s++)i=VARIABLE_TYPES[s],e.toLowerCase()===i.name&&i.cast(t)&&(r=!0);return r},t}(),Rule=function(){function t(t,e,r){this.update=__bind(this.update,this),("string"==typeof t||"Number"==typeof t)&&(this.callback=e,this.router=r,this.update(t))}return t.prototype.rule="",t.prototype._regexp=null,t.prototype.callback=null,t.prototype.name="",t.prototype.router=null,t.prototype.isVariable=!1,t.prototype.types=[],t.prototype.test=function(t){return this._regexp.test(t)},t.prototype._ruleToRegExp=function(t){var e;return e=t.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,"([^/]+)").replace(splatParam,"(.*?)"),RegExp("^"+e+"$")},t.prototype.update=function(t){var e,r,i,s,n,o,a;if(this.rule=t+this.rule,"/"!==this.rule&&(this.rule=this.rule.replace(trailingSlash,"")),this._regexp=this._ruleToRegExp(this.rule),i=RegExp(namedParam),r=t.match(i),null!==r){for(this.isVariable=!0,a=[],n=0,o=r.length;o>n;n++)e=r[n],s=e.match(genericParam)||null,a.push(this.types.push(null!==s?s[1]:null));return a}},t}(),InternalGroup=function(){function t(t,e){this.prefix=t,this.rules=e}return t.prototype.prefix=null,t.prototype.rules=[],t}(),EventDispatcher=function(){function t(){}return t.prototype.listeners={},t.prototype.addEventListener=function(t,e){void 0===this.listeners[t]&&(this.listeners[t]=[]),0>this._inArray(e,this.listeners[t])&&this.listeners[t].push(e)},t.prototype.removeEventListener=function(t,e){var r,i,s,n;s=0;for(n in this.listeners)s++;if(!(1>s)&&(r=this.listeners[t]))for(i=0,s=r.length;s>i;){if(r[i]===e){1===s?delete this.listeners[t]:r.splice(i,1);break}i++}},t.prototype.dispatchEvent=function(t){var e,r,i,s;if(e=this.listeners[t.type],void 0!==e)for(t.target=this,i=0,s=e.length;s>i;i++)r=e[i],r.call(this,t)},t.prototype._inArray=function(t,e){var r,i;for(r=0,i=e.length;i>r;){if(e[r]===t)return r;r++}return-1},t}(),Deffered=function(t){function e(){this.queue=[],this.isSuspend=!1}return __extends(e,t),e.prototype.queue=[],e.prototype.isSuspend=!1,e.prototype.deffered=function(t){return this.queue.push(t),this},e.prototype.execute=function(){var t;if(!this.isSuspend)try{if(t=this.queue.shift(),t&&t.apply(this,arguments),1>this.queue.length)return this.queue=[],this.dispatchEvent(new KazitoriEvent(KazitoriEvent.TASK_QUEUE_COMPLETE))}catch(e){return this.reject(e)}},e.prototype.reject=function(t){var e;return e=t?t:"user reject",this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILED,index:this.index,message:e}),this.isSuspend=!1},e.prototype.suspend=function(){this.isSuspend=!0},e.prototype.resume=function(){this.isSuspend=!1,this.execute()},e}(EventDispatcher),KazitoriEvent=function(){function t(t,e,r){this.type=t,this.next=e,this.prev=r}return t.prototype.next=null,t.prototype.prev=null,t.prototype.type=null,t.prototype.clone=function(){return new t(this.type,this.next,this.prev)},t.prototype.toString=function(){return"KazitoriEvent :: type:"+this.type+" next:"+(this.next+"")+" prev:"+(this.prev+"")},t}(),KazitoriEvent.TASK_QUEUE_COMPLETE="task_queue_complete",KazitoriEvent.TASK_QUEUE_FAILED="task_queue_failed",KazitoriEvent.CHANGE="change",KazitoriEvent.EXECUTED="executed",KazitoriEvent.BEFORE_EXECUTED="before_executed",KazitoriEvent.INTERNAL_CHANGE="internal_change",KazitoriEvent.USER_CHANGE="user_change",KazitoriEvent.PREV="prev",KazitoriEvent.NEXT="next",KazitoriEvent.REJECT="reject",KazitoriEvent.NOT_FOUND="not_found",KazitoriEvent.START="start",KazitoriEvent.STOP="stop",KazitoriEvent.SUSPEND="SUSPEND",KazitoriEvent.RESUME="resume",KazitoriEvent.FIRST_REQUEST="first_request",KazitoriEvent.ADDED="added",KazitoriEvent.REMOVED="removed";