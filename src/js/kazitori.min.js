/*! kazitori.js - v0.9.10 - 2013-12-09
* https://github.com/glassesfactory/kazitori.js
* Copyright (c) 2013 Eikichi Yamaguchi; Licensed MIT */
var Deffered,EventDispatcher,Kazitori,KazitoriEvent,Rule,VARIABLE_TYPES,delegater,escapeRegExp,genericParam,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};delegater=function(a,b){return function(){return b.apply(a,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/<(\w+|[A-Za-z_-]+:\w+)>/g,genericParam=/([A-Za-z_-]+):(\w+)/,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,VARIABLE_TYPES=[{name:"int",cast:Number},{name:"string",cast:String}],Kazitori=function(){function a(a){this.observeURLHandler=__bind(this.observeURLHandler,this),this.beforeFailed=__bind(this.beforeFailed,this),this.executeHandlers=__bind(this.executeHandlers,this),this._executeBefores=__bind(this._executeBefores,this),this.beforeComplete=__bind(this.beforeComplete,this);var b,c,d;this._processStep.status="constructor",this._processStep.args=[a],this.options=a||(a={}),a.routes&&(this.routes=a.routes),this.root=a.root?a.root:null===this.root?"/":this.root,this.isTemae=a.isTemae?a.isTemae:!1,this.silent=a.silent?a.silent:!1,this._params={params:[],queries:{},fragment:null},null===this.notFound&&(this.notFound=a.notFound?a.notFound:this.root),d=window,"undefined"!=typeof d&&(this.location=d.location,this.history=d.history),b=document.docmentMode,this.isIE=-1!==d.navigator.userAgent.toLowerCase().indexOf("msie"),this.isOldIE=this.isIE&&(!b||7>b),this._dispatcher=new EventDispatcher,this.handlers=[],this.beforeHandlers=[],this._bindBefores(),this._bindRules(),this._bindNotFound();try{Object.defineProperty(this,"params",{enumerable:!0,get:function(){return this._params.params}}),Object.defineProperty(this,"queries",{enumerable:!0,get:function(){return this._params.queries}})}catch(e){c=e}(null==this.options.isAutoStart||this.options.isAutoStart!==!1)&&this.start()}return a.prototype.VERSION="0.9.10",a.prototype.history=null,a.prototype.location=null,a.prototype.routes={},a.prototype.handlers=[],a.prototype.befores={},a.prototype.beforeHandlers=[],a.prototype.beforeAnytimeHandler=null,a.prototype.afterhandlers=[],a.prototype.rootFiles=["index.html","index.htm","index.php","unko.html"],a.prototype.root=null,a.prototype.notFound=null,a.prototype.direct=null,a.prototype.isIE=!1,a.prototype.silent=!1,a.prototype.started=!1,a.prototype._params={params:[],fragment:""},a.prototype.beforeFailedHandler=function(){},a.prototype.isBeforeForce=!1,a.prototype.isTemae=!1,a.prototype._changeOptions=null,a.prototype.isNotFoundForce=!1,a.prototype._notFound=null,a.prototype.breaker={},a.prototype._dispatcher=null,a.prototype._beforeDeffer=null,a.prototype.fragment=null,a.prototype.lastFragment=null,a.prototype.isUserAction=!1,a.prototype._isFirstRequest=!0,a.prototype.isSuspend=!1,a.prototype._processStep={status:"null",args:[]},a.prototype.start=function(a){var b,c,d,e,f,g;if(this._processStep.status="start",this._processStep.args=[a],this.started)throw new Error("mou hazim matteru");return this.started=!0,g=window,this.options=this._extend({},{root:"/"},this.options,a),this._hasPushState=!(!this.history||!this.history.pushState),this._wantChangeHash=this.options.hashChange!==!1,c=this.fragment=this.getFragment(),b=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isIE&&!b&&(e=this.location.pathname.replace(this.root,""),this._updateHashIE(e)),this.isOldIE&&this._wantChangeHash&&(d=document.createElement("iframe"),d.setAttribute("src","javascript:0"),d.setAttribute("tabindex","-1"),d.style.display="none",document.body.appendChild(d),this.iframe=d.contentWindow,this.change(c)),this._addPopStateHandler(),this._hasPushState&&b&&this.location.hash&&(this.fragment=this.lastFragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.START,this.fragment)),f=this.root,this.silent||(!this._hasPushState&&b?f=this.root+this.fragment.replace(routeStripper,""):b||(f=this.fragment)),this.loadURL(f)},a.prototype.stop=function(){var a;return a=window,a.removeEventListener("popstate",this.observeURLHandler),a.removeEventListener("hashchange",this.observeURLHandler),this.started=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.STOP,this.fragment))},a.prototype.torikazi=function(a){return this.direction(a,"next")},a.prototype.omokazi=function(a){return this.direction(a,"prev")},a.prototype.direction=function(a,b){var c;if(!this.started)return!1;if(c=this.lastFragment,this.lastFragment=this.getFragment(),this.direct=b,this.isUserAction=!0,this._removePopStateHandler(),"prev"===b)this.history.back(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,c,this.lastFragment));else{if("next"!==b)return;this.history.forward(),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,c,this.lastFragment))}return this._addPopStateHandler(),this.loadURL(c)},a.prototype.change=function(a,b){var c,d,e,f;return this.started?(this._processStep.status="change",this._processStep.args=[a,b],b||(b={trigger:b}),this._changeOptions=b,this.isBeforeForce=b.isBeforeForce!==!1,c=this.getFragment(a||""),this.fragment!==c?(this.lastFragment=this.fragment,this.fragment=c,e=this.fragment,f=this.root+this._replace.apply(c,[routeStripper,""]),d=this._matchCheck(this.fragment,this.handlers),d===!1&&this.isNotFoundForce===!1?(null!==this.notFound&&(this._notFound.callback(this.fragment),f=this.root+this._notFound.rule.replace(routeStripper,""),this.history[b.replace?"replaceState":"pushState"]({},document.title,f)),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND)),void 0):(this.isTemae&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(c):this._urlChange(c,b),void 0)):void 0):!1},a.prototype.replace=function(a,b){this._processStep.status="replace",this._processStep.args=[a,b],b?b.replace&&b.replace!==!1||(b.replace=!0):b={replace:!0},this.change(a,b)},a.prototype._urlChange=function(a,b){var c;if(this._processStep.status="_urlChange",this._processStep.args=[a,b],!this.isSuspend){if(b||(b=this._changeOptions),c=this.root+this.fragment.replace(routeStripper,""),!this.silent)if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantChangeHash)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}return this.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,this.fragment,this.lastFragment)),b.internal&&b.internal===!0&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.INTERNAL_CHANGE,this.fragment,this.lastFragment)),this.loadURL(this.fragment,b)}},a.prototype.reject=function(){this.dispatchEvent(new KazitoriEvent(KazitoriEvent.REJECT,this.fragment)),this._beforeDeffer&&(this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer=null)},a.prototype.suspend=function(){null!=this._beforeDeffer&&this._beforeDeffer.suspend(),this.started=!1,this.isSuspend=!0,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.SUSPEND,this.fragment,this.lastFragment))},a.prototype.resume=function(){null!=this._beforeDeffer&&this._beforeDeffer.resume(),this.started=!0,this.isSuspend=!1,this[this._processStep.status](this._processStep.args),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.RESUME,this.fragment,this.lastFragment))},a.prototype.registerHandler=function(b,c,d,e){var f,g,h;if(!e)if(d)e=this._bindFunctions(c);else{if(c instanceof a)return this._bindChild(b,c),this;if("function"==typeof c)if(c.hasOwnProperty("__super__"))try{return f=new c({isAutoStart:!1}),this._bindChild(b,f),this}catch(i){g=i,e=c}else e=c;else e=this[c]}return h=d?this.beforeHandlers:this.handlers,h.unshift(new Rule(b,function(a){var b;return b=this.router.extractParams(this,a),e&&e.apply(this.router,b)},this)),this},a.prototype._bindChild=function(a,b){var c,d,e,f,g,h,i,j;for(b.reject(),b.stop(),e=b.handlers.concat(),g=0,i=e.length;i>g;g++)f=e[g],f.update(a);for(this.handlers=e.concat(this.handlers),d=b.beforeHandlers.concat(),h=0,j=d.length;j>h;h++)c=d[h],c.update(a);return this.beforeHandlers=d.concat(this.beforeHandlers),b.beforeAnytimeHandler?(this.lastAnytime=this.beforeAnytime.concat(),this._bindBeforeAnytime(this.beforeAnytime,[b.beforeAnytimeHandler.callback])):void 0},a.prototype.appendRouter=function(b,c){var d,e,f;if(!b instanceof a&&"function"!=typeof b)throw new Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。");if(b instanceof a)return e=this._getChildRule(b,c),this._bindChild(e,b),this;if(b.hasOwnProperty("__super__"))try{return f=new b({isAutoStart:!1}),e=this._getChildRule(f,c),this._bindChild(e,f),this}catch(g){throw d=g,new Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。")}return this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.ADDED,this.fragment,this.lastFragment)),this},a.prototype._getChildRule=function(a,b){var c;if(c=a.root,b&&(c=b),c.match(trailingSlash)&&(c=c.replace(trailingSlash,"")),c===this.root)throw new Error("かぶってる");return c},a.prototype.removeRouter=function(b,c){var d,e;if(!b instanceof a&&"function"!=typeof b)throw new Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。");if(b instanceof a)this._unbindChild(b,c);else if(b.hasOwnProperty("__super__"))try{return e=new b({isAutoStart:!1}),this._unbindChild(e,c),this}catch(f){throw d=f,new Error("引数の値が不正です。 引数として与えられるオブジェクトは Kazitori を継承している必要があります。")}return this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.REMOVED,this.fragment,this.lastFragment)),this},a.prototype._unbindChild=function(a,b){var c,d,e,f,g,h,i;for(h=this._getChildRule(a,b),d=0,e=this.handlers.length,g=[];e>d;)i=this.handlers.shift(),null===i.rule.match(h)&&g.unshift(i),d++;for(this.handlers=g,d=0,e=this.beforeHandlers.length,f=[];e>d;)c=this.beforeHandlers.shift(),null===c.rule.match(h)&&f.unshift(c),d++;return this.beforeHandlers=f},a.prototype.loadURL=function(a,b){var c;this._processStep.status="loadURL",this._processStep.args=[a,b],this.isSuspend||(c=this.fragment=this.getFragment(a),this.isTemae===!1&&(this.beforeAnytimeHandler||this.beforeHandlers.length>0)?this._executeBefores(c):this.executeHandlers())},a.prototype.match=function(a){var b;return b=this._matchCheck(a,this.handlers,!0),b.length>0},a.prototype.beforeComplete=function(){this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.BEFORE_EXECUTED,this.fragment,this.lastFragment)),this.isTemae?this._urlChange(this.fragment,this._changeOptions):this.executeHandlers()},a.prototype._executeBefores=function(a){var b,c,d,e,f=this;for(this._processStep.status="_executeBefores",this._processStep.args=[a],this._beforeDeffer=new Deffered,null!=this.beforeAnytimeHandler&&this._beforeDeffer.deffered(function(b){f.beforeAnytimeHandler.callback(a),b.execute(b)}),c=this._matchCheck(a,this.beforeHandlers),d=0,e=c.length;e>d;d++)b=c[d],this._beforeDeffer.deffered(function(c){b.callback(a),c.execute(c)});return this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.execute(this._beforeDeffer)},a.prototype.executeHandlers=function(){var a,b,c,d,e,f,g,h,i=this;if(this._processStep.status="executeHandlers",this._processStep.args=[],!this.isSuspend){if(d=this._matchCheck(this.fragment,this.handlers),b=!0,d===!1||d.length<1)null!==this.notFound&&this._notFound.callback(this.fragment),b=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NOT_FOUND));else if(d.length>1)for(e=0,g=d.length;g>e;e++)c=d[e],this.fragment.indexOf(c.rule)>-1&&c.callback(this.fragment);else for(f=0,h=d.length;h>f;f++)a=d[f],a.callback(this.fragment);return this._isFirstRequest?(setTimeout(function(){return i._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.FIRST_REQUEST,i.fragment,null)),b?i._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,i.fragment,null)):void 0},0),this._isFirstRequest=!1):b&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.EXECUTED,this.fragment,this.lastFragment)),d}},a.prototype.beforeFailed=function(){this.beforeFailedHandler.apply(this,arguments),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILED,this.beforeFailed),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},a.prototype.observeURLHandler=function(){var a;return a=this.getFragment(),a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe))),a===this.fragment?!1:(this.iframe&&this.change(a),this.lastFragment===a&&this.isUserAction===!1?this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.PREV,a,this.fragment)):this.lastFragment===this.fragment&&this.isUserAction===!1&&this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.NEXT,a,this.lastFragment)),this.isUserAction=!1,this._dispatcher.dispatchEvent(new KazitoriEvent(KazitoriEvent.CHANGE,a,this.lastFragment)),this.loadURL(a))},a.prototype._bindRules=function(){var a,b,c,d;if(null!=this.routes)for(a=this._keys(this.routes),c=0,d=a.length;d>c;c++)b=a[c],this.registerHandler(b,this.routes[b],!1)},a.prototype._bindBefores=function(){var a,b,c,d;if(this.beforeAnytime&&this._bindBeforeAnytime(this.beforeAnytime),null!=this.befores)for(a=this._keys(this.befores),c=0,d=a.length;d>c;c++)b=a[c],this.registerHandler(b,this.befores[b],!0)},a.prototype._bindBeforeAnytime=function(a,b){var c;return c=this._bindFunctions(a,b),this.beforeAnytimeHandler={callback:this._binder(function(a){var b;return b=[a],c&&c.apply(this,b)},this)}},a.prototype._bindNotFound=function(){var a,b,c,d,e,f,g;if(null!=this.notFound){if("string"==typeof this.notFound){for(g=this.handlers,e=0,f=g.length;f>e;e++)if(d=g[e],d.rule==="/"+this.notFound.replace(this.root,""))return this._notFound=d,void 0}else b=this._keys(this.notFound)[0];c=this.notFound[b],a="function"==typeof c?c:this[c],this._notFound=new Rule(b,function(b){var c;return c=this.router.extractParams(this,b),a&&a.apply(this.router,c)},this)}},a.prototype._updateHash=function(a,b,c){var d;c?(d=a.href.replace(/(javascript:|#).*$/,""),a.replace(d+"#"+b)):a.hash="#"+b},a.prototype._updateHashIE=function(a){return location.replace(this.root+"#/"+a)},a.prototype._matchCheck=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(null==c&&(c=!1),m=[],o=a,void 0!==o&&"undefined"!==o&&(i=this._match.apply(o,[/(\?[\w\d=|]+)/g])),i&&(a=a.split("?")[0]),p=0,r=b.length;r>p;p++)if(h=b[p],h.rule===a)m.push(h);else if(h.test(a))if(h.isVariable&&h.types.length>0){for(e=this.extractParams(h,a,c),f=[],k=e.length,j=0;k>j;)d=e[j],n=h.types[j],"object"!=typeof d&&(null===n?f.push(!0):f.push(this._typeCheck(d,n))),j++;for(g=!0,q=0,s=f.length;s>q;q++)l=f[q],l||(g=!1);g&&m.push(h)}else m.push(h);return m.length>0?m:!1},a.prototype.getFragment=function(a){var b,c,d,e,f,g,h;if(null==a||void 0===a)if(this._hasPushState||!this._wantChangeHash){for(a=this.location.pathname,d=!1,b=a,b.match(/^\//)&&(b=b.substr(1)),e=this.root,e.match(/^\//)&&(e=e.substr(1)),h=this.rootFiles,f=0,g=h.length;g>f;f++)c=h[f],(c===b||e+c===b)&&(d=!0);d&&(a=this.root),a+=this.location.search,e=this.root.replace(trailingSlash,""),a.indexOf(e)>-1&&(a=a.substr(e.length))}else a=this.getHash();else e=this.root.replace(trailingSlash,""),a.indexOf(this.root)>-1&&a.indexOf(e)>-1&&(a=a.substr(e.length));return"string"==typeof a&&(a=a.replace(trailingSlash,""),""===a&&(a="/")),a},a.prototype.getHash=function(){var a;return a=(window||this).location.href.match(/#(.*)$/),null!=a?a[1]:""},a.prototype.extractParams=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;if(null==c&&(c=!1),this._params.params.length>0&&this._params.fragment===b)return this._params.params;if(i=a._regexp.exec(b),null===i&&b.indexOf("?")>-1&&(i=[0,"?"+b.split("?")[1]]),this._params.fragment=b,null!=i){if(g=i.slice(1),f=i[i.length-1],f.indexOf("?")>-1){for(h={},k=f.split("?")[1],m=k.split("&"),o=0,p=m.length;p>o;o++)l=m[o],e=l.split("="),d=e[0],n=e[1]?e[1]:"",n.indexOf("|")>-1&&(n=n.split("|")),h[d]=n;g.pop(),g.push(f.split("?")[0]),j={queries:h},g.push(j),c||(this._params.params=this._getCastedParams(a,g.slice(0)),this._params.queries=h)}else c||(this._params.params=this._getCastedParams(a,g));return g}return this._params.params=[],null},a.prototype._getCastedParams=function(a,b){var c,d,e,f,g,h;if(d=0,!b)return b;if(a.types.length<1)return b;for(e=b.length,c=[];e>d;){if(null===a.types[d])c.push(b[d]);else if("object"==typeof b[d])c.push(b[d]);else for(g=0,h=VARIABLE_TYPES.length;h>g;g++)f=VARIABLE_TYPES[g],a.types[d]===f.name&&c.push(f.cast(b[d]));d++}return c},a.prototype.addEventListener=function(a,b){return this._dispatcher.addEventListener(a,b)},a.prototype.removeEventListener=function(a,b){return this._dispatcher.removeEventListener(a,b)},a.prototype.dispatchEvent=function(a){return this._dispatcher.dispatchEvent(a)},a.prototype._addPopStateHandler=function(){var a;return a=window,this._hasPushState===!0&&a.addEventListener("popstate",this.observeURLHandler),this._wantChangeHash===!0&&__indexOf.call(a,"onhashchange")>=0&&!this.isOldIE?a.addEventListener("hashchange",this.observeURLHandler):void 0},a.prototype._removePopStateHandler=function(){var a;return a=window,a.removeEventListener("popstate",this.observeURLHandler),a.removeEventListener("hashchange",this.observeURLHandler)},a.prototype._slice=Array.prototype.slice,a.prototype._replace=String.prototype.replace,a.prototype._match=String.prototype.match,a.prototype._keys=Object.keys||function(a){var b,c;if(a===!Object(a))throw new TypeError("object ja nai");c=[];for(b in a)Object.hasOwnProperty.call(a,b)&&(c[c.length]=b);return c},a.prototype._binder=function(a,b){var c,d;return d=this._slice,c=d.call(arguments,2),function(){return a.apply(b||{},c.concat(d.call(arguments)))}},a.prototype._extend=function(a){return this._each(this._slice.call(arguments,1),function(b){var c,d;if(b){d=[];for(c in b)d.push(a[c]=b[c]);return d}}),a},a.prototype._each=function(a,b,c){var d,e,f,g;if(null!=a){if(d=Array.prototype.forEach,d&&a.forEach===d)return a.forEach(b,c);if(a.length===+a.length)for(e=0,g=a.length;g>e;){if(b.call(c,a[e],e,a)===this.breaker)return;e++}else for(f in a)if(__indexOf.call(a,f)>=0&&b.call(c,a[f],f,a)===this.breaker)return}},a.prototype._bindFunctions=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for("string"==typeof a&&(a=a.split(",")),c=[],l=0,m=a.length;m>l;l++){if(g=a[l],f=this[g],null==f)if(j=g.split("."),j.length>1){for(e=window[j[0]],h=1,i=j.length;i>h&&(k=e[j[h]],null!=k);)e=k,h++;f=e}else f=window[g];null!=f&&c.push(f)}return b&&(c=b.concat(c)),d=function(a){var b,d;for(b=0,d=c.length;d>b;b++)f=c[b],f.apply(this,[a])}},a.prototype._typeCheck=function(a,b){var c,d,e,f;for(c=!1,e=0,f=VARIABLE_TYPES.length;f>e;e++)d=VARIABLE_TYPES[e],b.toLowerCase()===d.name&&d.cast(a)&&(c=!0);return c},a}(),Rule=function(){function a(a,b,c){this.update=__bind(this.update,this),("string"==typeof a||"Number"==typeof a)&&(this.callback=b,this.router=c,this.update(a))}return a.prototype.rule="",a.prototype._regexp=null,a.prototype.callback=null,a.prototype.name="",a.prototype.router=null,a.prototype.isVariable=!1,a.prototype.types=[],a.prototype.test=function(a){return this._regexp.test(a)},a.prototype._ruleToRegExp=function(a){var b;return b=a.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,"([^/]+)").replace(splatParam,"(.*?)"),new RegExp("^"+b+"$")},a.prototype.update=function(a){var b,c,d,e,f,g,h;if(this.rule=a+this.rule,"/"!==this.rule&&(this.rule=this.rule.replace(trailingSlash,"")),this._regexp=this._ruleToRegExp(this.rule),d=new RegExp(namedParam),c=a.match(d),null!==c){for(this.isVariable=!0,h=[],f=0,g=c.length;g>f;f++)b=c[f],e=b.match(genericParam)||null,h.push(this.types.push(null!==e?e[1]:null));return h}},a}(),EventDispatcher=function(){function a(){}return a.prototype.listeners={},a.prototype.addEventListener=function(a,b){void 0===this.listeners[a]&&(this.listeners[a]=[]),this._inArray(b,this.listeners[a])<0&&this.listeners[a].push(b)},a.prototype.removeEventListener=function(a,b){var c,d,e,f;e=0;for(f in this.listeners)e++;if(!(1>e)&&(c=this.listeners[a]))for(d=0,e=c.length;e>d;){if(c[d]===b){1===e?delete this.listeners[a]:c.splice(d,1);break}d++}},a.prototype.dispatchEvent=function(a){var b,c,d,e;if(b=this.listeners[a.type],void 0!==b)for(a.target=this,d=0,e=b.length;e>d;d++)c=b[d],c.call(this,a)},a.prototype._inArray=function(a,b){var c,d;for(c=0,d=b.length;d>c;){if(b[c]===a)return c;c++}return-1},a}(),Deffered=function(a){function b(){this.queue=[],this.isSuspend=!1}return __extends(b,a),b.prototype.queue=[],b.prototype.isSuspend=!1,b.prototype.deffered=function(a){return this.queue.push(a),this},b.prototype.execute=function(){var a,b;if(!this.isSuspend)try{if(b=this.queue.shift(),b&&b.apply(this,arguments),this.queue.length<1)return this.queue=[],this.dispatchEvent(new KazitoriEvent(KazitoriEvent.TASK_QUEUE_COMPLETE))}catch(c){return a=c,this.reject(a)}},b.prototype.reject=function(a){var b;return b=a?a:"user reject",this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILED,index:this.index,message:b}),this.isSuspend=!1},b.prototype.suspend=function(){this.isSuspend=!0},b.prototype.resume=function(){this.isSuspend=!1,this.execute()},b}(EventDispatcher),KazitoriEvent=function(){function a(a,b,c){this.type=a,this.next=b,this.prev=c}return a.prototype.next=null,a.prototype.prev=null,a.prototype.type=null,a.prototype.clone=function(){return new a(this.type,this.next,this.prev)},a.prototype.toString=function(){return"KazitoriEvent :: type:"+this.type+" next:"+String(this.next)+" prev:"+String(this.prev)},a}(),KazitoriEvent.TASK_QUEUE_COMPLETE="task_queue_complete",KazitoriEvent.TASK_QUEUE_FAILED="task_queue_failed",KazitoriEvent.CHANGE="change",KazitoriEvent.EXECUTED="executed",KazitoriEvent.BEFORE_EXECUTED="before_executed",KazitoriEvent.INTERNAL_CHANGE="internal_change",KazitoriEvent.USER_CHANGE="user_change",KazitoriEvent.PREV="prev",KazitoriEvent.NEXT="next",KazitoriEvent.REJECT="reject",KazitoriEvent.NOT_FOUND="not_found",KazitoriEvent.START="start",KazitoriEvent.STOP="stop",KazitoriEvent.SUSPEND="SUSPEND",KazitoriEvent.RESUME="resume",KazitoriEvent.FIRST_REQUEST="first_request",KazitoriEvent.ADDED="added",KazitoriEvent.REMOVED="removed";